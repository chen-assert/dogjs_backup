<html>
  <head>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.13.3/dist/tf.min.js"> </script>

    <body onload="init()">
        <img src="/static/pic/peking.jpg" id="img"></img>
    </body>

    <!-- Place your code in the script tag below. You can also use an external .js file -->
    <script>
      var model;
        
      //image to tensor
      function itt(img){
            tensor = tf.fromPixels(img);
            resized = tf.image.resizeBilinear(tensor, [224, 224]).toFloat();
            expanded = tf.expandDims(resized,0);
            return expanded;
      }

      function itt0(img){
            //tensor = tf.fromPixels(img).toFloat();
            //const offset = tf.scalar(127.5);
            // Normalize the image from [0, 255] to [-1, 1].
            //const normalized = tensor.sub(offset).div(offset);
            // Reshape to a single-element batch so we can pass it to predict.
            //const batched = normalized.reshape([1, 224, 224, 3]);

            const image = tf.fromPixels(img).toFloat()
            const resized = tf.image.resizeBilinear(image, [224, 224])
            const offset = tf.scalar(255 / 2)
            const normalized = resized.sub(offset).div(offset)
            const input = normalized.expandDims(0)
            return input;

            return batched;
      }

      function itt1(img){
        const tfImg = tf.fromPixels(img);
        const smalImg = tf.image.resizeBilinear(tfImg, [224, 224]);
        const resized = tf.cast(smalImg, 'float32');
        const t4d = tf.tensor4d(Array.from(resized.dataSync()),[1,224,224,3])
        return t4d;
      }

      //async function init(){
    const init = async() =>{
       model = tf.loadFrozenModel("/static/models/tensorflowjs_model.pb","/static/models/weights_manifest.json");
        model.then (res => {
            console.log("model loaded");
            console.log(res);
            model = res;
            const img = document.getElementById('img');
            //console.log(resized);
            //const m = tf.moments(resized)
            //     console.log(re)
            //const scalar = tf.scalar(1.0);
            //const offset = tf.scalar(255.0);
            // const re = tf.batchNormalization(resized, m['mean'], m['variance'])
            //console.log(expanded);
            //prediction = model.predict(img_to_tensor_alt(img));
            
            //prediction = model.predict(itt0(img));

            const prediction = model.predict({ Placeholder: itt0(img) });
            prediction.print(true);
            prediction.argMax(1).print();
            })
      }
    </script>
  </head>

  <body>
  </body>
</html>